import type { NextPage } from "next";
import Head from "next/head";
import React, { useRef, useState } from "react";
import { Toast, ToastMessage } from "primereact/toast";
import styles from "../styles/Home.module.css";

const Home: NextPage = () => {
  const [checked, setChecked] = useState(false);
  const [email, setEmail] = useState<string>("");
  const [keywords, setKeywords] = useState<string[]>([]);
  const [keywordsBackup, setKeywordsBackup] = useState<string[]>([]);
  const [sending, setSending] = useState(false);
  const toast = useRef<Toast>(null);

  const handleKeywordsChange = (values: string[]) =>
    setKeywords(values.map((v) => v.toLocaleLowerCase()));

  const handleAllKeywordsChecked = (value: boolean) => {
    if (value) {
      setKeywordsBackup([...keywords]);
      setKeywords(["*"]);
    } else setKeywords([...keywordsBackup]);
    setChecked(value);
  };

  const handleSubscribeClick = async () => {
    setSending(true);
    try {
      const response = await fetch("/api/subscribe", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ email, keywords }),
      });
      const { ok, status } = response;
      const toastMessage: ToastMessage =
        ok && status === 202
          ? {
              severity: "success",
              summary: "Inscrição com sucesso!",
              detail:
                "Sua inscrição foi realizada com sucesso! Por gentileza, confira se você recebeu nosso e-mail de validação.",
              life: 10000,
            }
          : {
              severity: "error",
              summary: "Erro na inscrição!",
              detail:
                "Sua inscrição não pôde ser finalizada! Por gentileza, verifique os dados preenchidos.",
              life: 10000,
            };

      toast.current?.show(toastMessage);
    } catch (error) {
      console.error(error);
    } finally {
      setSending(false);
    }
  };

  return (
    <>
      <Head>
        <title>Boletim Diário - Rio Preto</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <div className={styles.container}>
        <header className={styles.header}>
          <div className={styles.title_box}>
            <h1 className={styles.title_1}>Boletim do Diário Oficial</h1>
            <h2 className={styles.title_2}>São José do Rio Preto-SP</h2>
          </div>
        </header>
        <main className={styles.main}>
          <section className={styles.subscribe_section}>
            <h1>Inscreva-se gratuitamente!</h1>
            <div className={styles.input_email}>
              <label htmlFor="inputEmail">E-mail:</label>
              <input
                id="inputEmail"
                type="email"
                placeholder="digite seu e-mail"
              />
            </div>
            <div>
              <input
                id="inputRadioAllPublications"
                type="radio"
                name="keywords-flag"
                checked
              />
              <label htmlFor="inputRadioAllPublications">
                Todas as publicações
              </label>
            </div>
            <div>
              <input
                id="inputRadioByKeywords"
                type="radio"
                name="keywords-flag"
              />
              <label htmlFor="inputRadioByKeywords">
                Por palavras-chave <i>help</i>
              </label>
            </div>
            <div>
              <label htmlFor="inputKeywords">Palavras-chave:</label>
              <div>
                <input
                  id="inputKeywords"
                  type="text"
                  placeholder="palavras-chave"
                />
                <button type="button">✖️</button>
              </div>
            </div>
          </section>
        </main>
        <footer className={styles.footer}>
          <h4>Andrielson</h4>
        </footer>
      </div>
    </>
  );
};

export default Home;
